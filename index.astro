---
import fs from "node:fs";
import path from "node:path";
import Sidebar from "astro-html/Sidebar.astro";

let failed = false;

async function findTemplates(
	basePath: string,
	relativePath: string = "",
	currentDepth: number = 0,
	maxDepth: number = 2,
): Promise<any[]> {
	if (currentDepth > maxDepth) {
		return [];
	}

	const fullPath = path.resolve(basePath, relativePath);
	const items = fs.readdirSync(fullPath);
	const results: any[] = [];

	for (const item of items) {
		const itemPath = path.resolve(fullPath, item);
		const stat = fs.statSync(itemPath);

		try {
			if (stat.isDirectory()) {
				const subResults = await findTemplates(
					basePath,
					path.join(relativePath, item),
					currentDepth + 1,
					maxDepth,
				);
				results.push(...subResults);
			} else {
				if (!itemPath.endsWith(".astro")) {
					continue;
				}

				const astroPageRaw = { default: fs.readFileSync(itemPath, "utf-8") };
				const frontMatterMatch = astroPageRaw.default?.match(
					/^---\s*([\s\S]*?)\s*---/,
				);

				// Extract only export statements from frontmatter
				let exportStatements = "";
				if (frontMatterMatch) {
					const frontMatter = frontMatterMatch[1];
					const exportMatches = frontMatter.match(
						/export\s+[\s\S]*?(?=export\s+|$)/g,
					);
					if (exportMatches) {
						exportStatements = exportMatches.join("\n");
					}
				}

				const frontMatterToProcess = exportStatements || "";

				let exprts = {};

				// TODO: This limits us to not use relative file imports. Why cant we import astro file here at build time.
				if (frontMatterMatch) {
					const frontMatterModule = await import(
						`data:text/javascript,${encodeURIComponent(frontMatterToProcess)}`
					);
					exprts = frontMatterModule;
				}

				const templateName = (
					relativePath ? path.join(relativePath, item) : item
				).replace(".astro", "");

				// Check if getStaticPaths exists and generate multiple pages if so
				if (
					exprts.getStaticPaths &&
					typeof exprts.getStaticPaths === "function"
				) {
					const staticPaths = await exprts.getStaticPaths();

					for (const pathData of staticPaths) {
						let pageName = templateName;
						for (const key in pathData.params) {
							pageName = pageName.replace(`[${key}]`, pathData.params[key]);
						}

						results.push({
							name: pageName,
							config: exprts.config,
							params: pathData.params,
						});
					}
				} else {
					results.push({
						name: templateName,
						config: exprts.config,
					});
				}
			}
		} catch (err) {
			console.error(err);
			failed = true;
		}
	}

	return results;
}

const templates = await findTemplates("src/pages", "", 0, 2);

if (failed) {
	throw new Error("Failed to build pages");
}
---

<html>
  <head>
    <meta charset="UTF-8">
    <title>Astro Email</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <Fragment
      set:html={`
        <script id="data" type="application/json">${JSON.stringify(
          {
            pages: templates,
          },
          null,
          "  "
        )}</script>
      `}
    />
    
    <style>
      body {
        font-family: sans-serif, Arial;
        height: 100vh;
        margin: 0;
        overscroll-behavior: none;
        overflow: hidden;
        font-size: 1rem;
      }

      body {
        background-color: #e5e5f7;
        background-image: linear-gradient(#eee 1px, transparent 1px), linear-gradient(to right, #eee 1px, #fff 1px);
        background-size: 20px 20px;
      }

      @media (prefers-color-scheme: dark) {
        body {
          background-color: hsl(258, 7%, 10%);
          color: #fff;
        }
      }

      iframe {
        border: none;
        max-height: 100%;
        max-width: 100%;
        flex: none;
      }

      h1 {
        opacity: 0.65;
        font-size: 0.65rem;
        font-weight: normal;
        text-transform: uppercase;
        margin: 0;
      }

      .preview-header {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 5px 20px;
        font-size: 0.75rem;
        color: #666;
      }

      .preview {
        display: grid;
        grid-template-rows: auto 1fr;
        justify-content: center;
        justify-items: center;
        height: 100%;
        margin: 0 20px;
      }

      .layout {
        height: 100%;
        display: grid;
        grid-template-columns: auto 1fr;
        grid-template-rows: 1fr;
      }

      .mobile-menu-toggle {
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #007bff;
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
        cursor: pointer;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
      }

      .mobile-menu-toggle:active {
        transform: scale(0.95);
      }

      @media (max-width: 768px) {
        .layout {
          grid-template-columns: 1fr;
        }

        .mobile-menu-toggle {
          display: flex;
        }

        .preview {
          margin: 0;
        }
      }

      @media (prefers-color-scheme: dark) {
        .mobile-menu-toggle {
          background: #0066cc;
          box-shadow: 0 4px 12px rgba(0, 102, 204, 0.4);
        }
      }
    </style>
  </head>

  <body>
    <button id="mobile-menu-toggle" class="mobile-menu-toggle" aria-label="Toggle menu">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 12h18M3 6h18M3 18h18"/>
      </svg>
    </button>

    <div class="layout">
      <Sidebar templates={templates} />

      <div class="preview">
        <div id="display-width" class="preview-header"></div>
        <iframe width="640px"></iframe>

        <script>
          const dataString = document.querySelector("#data")?.innerHTML;
          if (!dataString) throw new Error("No data found");

          const data = JSON.parse(dataString);
          console.debug("data", data);

          // Download assets functionality
          const downloadButton = document.querySelector("#download-assets");
          const hasAssets = downloadButton && downloadButton.getAttribute("data-has-assets") === "true";

          if (downloadButton) {
            if (!hasAssets) {
              downloadButton.disabled = true;
              downloadButton.innerHTML = `
                <svg width="12" height="12" viewBox="0 0 12 12" style="color: #6c757d;">
                  <circle cx="6" cy="6" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
                  <path d="M4.5 4.5l3 3M7.5 4.5l-3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                No Assets Built
              `;
              downloadButton.title = "Run 'npm run build' to generate downloadable assets";
            } else {
              downloadButton.addEventListener("click", () => {
                // Simple direct download of pre-built zip
                const link = document.createElement("a");
                link.href = "/assets.zip";
                link.download = "assets.zip";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Show success feedback
                const originalText = downloadButton.innerHTML;
                downloadButton.innerHTML = `
                  <svg width="12" height="12" viewBox="0 0 12 12" style="color: #22c55e;">
                    <path d="M2 6l2.5 2.5L9 4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Downloaded!
                `;

                setTimeout(() => {
                  downloadButton.innerHTML = originalText;
                }, 1500);
              });
            }
          }

          const iframe = document.querySelector("iframe");
          if (!iframe) throw new Error("No iframe found");

          let fixedWidth = undefined;
          let fixedHeight = undefined;

          const updateFormat = (name?: string) => {
            const config = data.pages.find((temp: { name: string }) => {
              return temp.name === `${name}`;
            })?.config;

            fixedWidth = config.width;
            fixedHeight = config.height;
            const width = fixedWidth || iframe?.offsetWidth || 0;
            const height = fixedHeight || iframe?.offsetHeight || 0;

            const display = document.querySelector("#display-width");
            if(display) {
              display.innerHTML = `${width}x${height}px`;
            }

            if(iframe) {
              iframe.width = `${width}`;
              iframe.height = `${height}`;
            }
          }

          let resizeListener: EventListener;

          function showTemplate(name: string) {
            if(!iframe) return;

            const config = data.pages.find((temp: { name: string }) => {
              return temp.name === `${name}`;
            })?.config;

            console.debug(name, config)

            updateFormat(name);

            iframe.src = `/${name}.html`;

            // Update active state
            document.querySelectorAll('.button').forEach(button => {
              button.classList.remove('active');
            });

            const activeButton = document.querySelector(`[data-template="${name}"]`);
            if (activeButton) {
              activeButton.classList.add('active');
            }

            window.removeEventListener("resize", resizeListener);

            resizeListener = () => updateFormat(name);

            window.addEventListener("resize", resizeListener);
          }

          const template = location.hash.substring(1);
          if (template) {
            showTemplate(template)
          } else {
            const first = data.pages[0]?.name.replace(".astro", "");
            showTemplate(first)
          }

          window.addEventListener("hashchange", () => {
            showTemplate(location.hash.substring(1));
          });

          // Mobile menu toggle
          const menuToggle = document.querySelector("#mobile-menu-toggle");
          const sidebar = document.querySelector("#sidebar");

          if (menuToggle && sidebar) {
            menuToggle.addEventListener("click", () => {
              sidebar.classList.toggle("open");
            });

            // Close sidebar when clicking a template link on mobile
            document.querySelectorAll('.button a[href^="#"]').forEach(link => {
              link.addEventListener("click", () => {
                if (window.innerWidth <= 768) {
                  sidebar.classList.remove("open");
                }
              });
            });
          }

        </script>
      </div>
    </div>
  </body>
</html>
